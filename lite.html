<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Bot Lite</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:-apple-system,system-ui,sans-serif; background:#111; color:#eee; height:100vh; display:flex; flex-direction:column; }
.top { padding:8px 12px; background:#1a1a2e; display:flex; gap:8px; align-items:center; border-bottom:1px solid #333; }
.top select { flex:1; background:#222; color:#fff; border:1px solid #444; border-radius:8px; padding:10px; font-size:16px; }
.top .status { width:10px; height:10px; border-radius:50%; background:#555; flex-shrink:0; }
.top .status.ok { background:#4ade80; }
.msgs { flex:1; overflow-y:auto; padding:8px 12px; display:flex; flex-direction:column; gap:4px; }
.msg { padding:6px 10px; border-radius:8px; font-size:14px; max-width:90%; word-break:break-all; }
.msg.sent { background:#1d4ed8; align-self:flex-end; }
.msg.err { background:#991b1b; align-self:flex-end; }
.msg.info { background:#333; align-self:flex-start; color:#aaa; font-size:12px; }
.bottom { padding:8px 12px; background:#1a1a2e; border-top:1px solid #333; display:flex; gap:8px; }
.bottom textarea { flex:1; background:#222; color:#fff; border:1px solid #444; border-radius:8px; padding:10px; font-size:16px; resize:none; height:44px; line-height:1.4; }
.bottom button { background:#2563eb; color:#fff; border:none; border-radius:8px; padding:0 20px; font-size:16px; cursor:pointer; white-space:nowrap; }
.bottom button:active { background:#1d4ed8; }
.bottom button:disabled { opacity:0.5; }
</style>
</head>
<body>
<div class="top">
  <div class="status" id="st"></div>
  <select id="sel"><option value="">Loading...</option></select>
</div>
<div class="msgs" id="msgs"></div>
<div class="bottom">
  <textarea id="inp" placeholder="输入命令..." rows="1"></textarea>
  <button id="btn" onclick="send()">发送</button>
</div>
<script>
let bots = [];
let sel = document.getElementById('sel');
let inp = document.getElementById('inp');
let btn = document.getElementById('btn');
let msgs = document.getElementById('msgs');
let st = document.getElementById('st');

async function loadBots() {
  try {
    const r = await fetch('/api/bots');
    bots = await r.json();
    sel.innerHTML = bots.map(b => `<option value="${b.bot_name}" data-win="${b.win_id}">${b.group} - ${b.bot_name}</option>`).join('');
    st.className = 'status ok';
    addMsg('info', bots.length + ' bots loaded');
  } catch(e) {
    st.className = 'status';
    addMsg('err', 'Load failed: ' + e.message);
  }
}

function addMsg(type, text) {
  const d = document.createElement('div');
  d.className = 'msg ' + type;
  d.textContent = text;
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
  // 只保留最近 50 条
  while (msgs.children.length > 50) msgs.removeChild(msgs.firstChild);
}

async function send() {
  const text = inp.value.trim();
  if (!text) return;
  const opt = sel.selectedOptions[0];
  if (!opt || !opt.dataset.win) return addMsg('err', 'No bot selected');

  const target = opt.dataset.win;
  inp.value = '';
  btn.disabled = true;
  addMsg('sent', text);

  try {
    const r = await fetch('/api/tmux', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ text, target })
    });
    const d = await r.json();
    if (!d.success) addMsg('err', d.error || 'Failed');
  } catch(e) {
    addMsg('err', e.message);
  } finally {
    btn.disabled = false;
    inp.focus();
  }
}

// Enter 发送
inp.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) {
    e.preventDefault();
    send();
  }
});

// 自动调整高度
inp.addEventListener('input', () => {
  inp.style.height = '44px';
  inp.style.height = Math.min(inp.scrollHeight, 120) + 'px';
});

loadBots();
</script>
</body>
</html>
